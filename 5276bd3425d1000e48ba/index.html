<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/uehaj-memo2/styles.57549d926a8ce7aa67e3.css">body,html{margin:0;padding:0}*{margin-top:0}body.light{--primary-color:#381696;--primary-text-color:#fff;--featured-bg:#493b8a;--secondary-color:#10072b;--background:#fff;--card-bg:#fff;--card-bdr:#eee;--card-shadow:#d5d5d5;--contact-bg:#f7f8fe;--contact-bdr:#d3d6e7;--input-bg:var(--background)}body.dark,body.light{--featured-text:#fff;--site-header:var(--background);--btn-bg:var(--background);--btn-bdr:#d3d6e7;--btn-text-color:#868892;--btn-hover-bg:var(--btn-bdr);--btn-hover-text-color:#00062b}body.dark{--primary-color:#9984d5;--primary-text-color:#fff;--featured-bg:#66578d;--secondary-color:#66578d;--background:#0a041a;--text-color:hsla(0,0%,100%,0.88);--text-secondary-color:hsla(0,0%,100%,0.66);--card-bg:#181326;--card-bdr:#181326;--card-shadow:#020204;--contact-bg:var(--card-shadow);--contact-bdr:var(--card-bg);--input-bg:var(--card-bg)}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif;border-top:10px solid var(--primary-color);background-color:var(--background);color:var(--text-color)}a{color:var(--primary-color);text-decoration:none}a:hover{text-decoration:underline}.site-wrapper{padding:32px;max-width:1140px;margin:0 auto}.site-wrapper img{max-width:100%}.navigation{display:flex;align-items:center;font-weight:300}.navigation a{color:#888;text-decoration:none;margin:0 8px}.navigation a[aria-current]{color:var(--primary-color);font-weight:700}.navigation a:hover{color:var(--primary-color)}.navigation a:last-child{margin-right:0}.site-header{display:flex;justify-content:space-between;padding:20px 0;background:var(--site-header);margin-bottom:32px;align-items:center}.site-title a{color:var(--primary-color);text-decoration:none;font-weight:900;text-transform:uppercase}.hero-header{padding:0 0 64px;max-width:980px}.headline{font-size:36px;font-weight:900;margin-bottom:.5rem}.button{padding:18px 27px;display:inline-block;background:var(--btn-bg);border:1px solid var(--btn-bdr);border-radius:9px;text-decoration:none;color:var(--btn-text-color);font-size:16px;font-weight:400;margin:0 20px 0 0;transition:background-color .3s linear}.button.-primary{background-color:var(--primary-color);border-color:var(--primary-color);color:var(--primary-text-color)}.button.-primary:hover{background-color:var(--secondary-color);color:var(--primary-text-color);text-decoration:none}.button:hover{background-color:var(--btn-hover-bg);color:var(--btn-hover-text-color)}.primary-content{font-size:18px;margin-bottom:32px;line-height:1.5;font-weight:300}.post{padding:0;background:var(--background);color:var(--text-color);line-height:1.5}.post>.blog-post-content{max-width:768px;margin:0 auto}.post>.blog-post-content :last-child,.post>:last-child{margin-bottom:0}.post .post-title{text-align:center;margin:0 0 .5rem;line-height:1.3;font-size:2rem}.post .post-meta{margin-bottom:32px;text-align:center}.post-thumbnail{text-align:center;min-height:380px;background-color:var(--featured-bg);background-repeat:no-repeat;background-size:cover;background-position:50%;border-radius:18px;margin-bottom:36px;color:var(--featured-text);display:grid;align-content:center;position:relative;padding:18px;overflow:hidden}.post-thumbnail:before{content:"";background:rgba(0,0,0,.4);position:absolute;top:0;left:0;width:100%;height:100%;z-index:1}.post-thumbnail>*{position:relative;z-index:2}.post-thumbnail .post-meta{color:hsla(0,0%,100%,.8);margin-bottom:0}.grids{display:grid;grid-template-columns:1fr;grid-gap:32px;margin-top:32px}.card{display:grid;background-color:var(--card-bg);border-radius:9px;border:1px solid var(--card-bdr);box-shadow:0 0 30px var(--card-shadow);overflow:hidden;line-height:1.5}.card:hover .post-link{color:var(--primary-color)}.card>a img{display:block}.card>header{padding:24px}.card>h2:first-child{margin:0 0 .5rem}.card .post-title{font-size:1.2rem;margin-bottom:.3rem}.card .post-meta{font-weight:100;margin-bottom:0}.card .post-link{color:var(--text-color);text-decoration:none}.post-meta{font-size:.8rem;color:var(--text-secondary-color)}.site-footer{text-align:center;margin:90px 0 16px;color:#666}.site-footer a{font-weight:700}.form-container{background-color:var(--contact-bg);padding:32px;border:1px solid var(--contact-bdr);border-radius:9px}.form-container label{display:block;margin-bottom:.5rem;color:var(--text-secondary-color)}.form-container input[type=email],.form-container input[type=text],.form-container textarea{-webkit-appearance:none;-moz-appearance:none;appearance:none;border:1px solid var(--card-shadow);color:var(--text-secondary-color);border-radius:6px;line-height:32px;padding:6px 12px;width:calc(100% - 24px);margin-bottom:1.5rem;background-color:var(--input-bg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}.form-container textarea{margin-bottom:2rem;height:150px}.two-grids{display:grid;grid-gap:32px}.two-grids.-contact .post-thumbnail{min-height:240px!important}@media only screen and (min-width:768px){.grids{grid-template-columns:1fr 1fr}}@media only screen and (min-width:1024px){.grids{grid-template-columns:1fr 1fr 1fr}.two-grids{display:grid;grid-template-columns:1fr 1fr;grid-gap:64px}}.theme-changer,body.dark .gg-moon,body.light .gg-sun{display:none}.mode-container{width:24px;height:24px;margin-left:20px}.gg-sun{position:relative;transform:scale(var(--ggs,1));height:24px;background:linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat 5px -6px/2px 6px,linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat 5px 14px/2px 6px,linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat -8px 5px/6px 2px,linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat 14px 5px/6px 2px;border-radius:100px;box-shadow:inset 0 0 0 2px;border:6px solid transparent}.gg-sun,.gg-sun:after,.gg-sun:before{box-sizing:border-box;display:block;width:24px}.gg-sun:after,.gg-sun:before{content:"";position:absolute;height:2px;border-right:4px solid;border-left:4px solid;left:-6px;top:5px}.gg-sun:before{transform:rotate(-45deg)}.gg-sun:after{transform:rotate(45deg)}.gg-moon,.gg-moon:after{display:block;box-sizing:border-box;border-radius:50%}.gg-moon{overflow:hidden;position:relative;transform:rotate(-135deg) scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-bottom:2px solid transparent}.gg-moon:after{content:"";position:absolute;width:12px;height:18px;border:2px solid transparent;box-shadow:0 0 0 2px;top:8px;left:2px}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.24.2"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-164743872-1', 'auto', {});
      
      
      
      
      
      }</script><link rel="icon" href="/uehaj-memo2/favicon-32x32.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="manifest" href="/uehaj-memo2/manifest.webmanifest"/><meta name="theme-color" content="#381696"/><link rel="apple-touch-icon" sizes="48x48" href="/uehaj-memo2/icons/icon-48x48.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="72x72" href="/uehaj-memo2/icons/icon-72x72.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="96x96" href="/uehaj-memo2/icons/icon-96x96.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="144x144" href="/uehaj-memo2/icons/icon-144x144.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="192x192" href="/uehaj-memo2/icons/icon-192x192.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="256x256" href="/uehaj-memo2/icons/icon-256x256.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="384x384" href="/uehaj-memo2/icons/icon-384x384.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="512x512" href="/uehaj-memo2/icons/icon-512x512.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><title data-react-helmet="true">WebAssemblyへのコンパイラ言語を簡単に実装 | Delog</title><meta data-react-helmet="true" name="description"/><link rel="sitemap" type="application/xml" href="/uehaj-memo2/sitemap.xml"/><link as="script" rel="preload" href="/uehaj-memo2/webpack-runtime-d61593428dc9acc550ef.js"/><link as="script" rel="preload" href="/uehaj-memo2/framework-a7bb16c5c6afeed647b2.js"/><link as="script" rel="preload" href="/uehaj-memo2/532a2f07-a09818a88319b8b503ee.js"/><link as="script" rel="preload" href="/uehaj-memo2/app-d756fd09c6f43fe69c21.js"/><link as="script" rel="preload" href="/uehaj-memo2/styles-89fd2ae28bdf06750a71.js"/><link as="script" rel="preload" href="/uehaj-memo2/b34906bb45276341108473925e234e3fd24b49e8-b5d8b872c6394f34f95f.js"/><link as="script" rel="preload" href="/uehaj-memo2/component---src-templates-blog-template-js-c07c43f15390ed3b46f3.js"/><link as="fetch" rel="preload" href="/uehaj-memo2/page-data/5276bd3425d1000e48ba/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/uehaj-memo2/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="site-wrapper"><header class="site-header"><div class="site-title"><a href="/uehaj-memo2/">Delog</a></div><nav class="navigation"><a href="/uehaj-memo2/contact">Contact</a><label><input type="checkbox" class="theme-changer"/> <div class="mode-container"><i class="gg-sun"></i><i class="gg-moon"></i></div></label></nav></header><div class="blog-post-container"><article class="post"><div class="post-thumbnail"><h1 class="post-title">WebAssemblyへのコンパイラ言語を簡単に実装</h1><div class="post-meta">January 01, 1970</div></div><div class="blog-post-content"><p>後入りですみませんが、WebAssemblyアドベントカレンダー未投稿のところ埋めさせて頂きます。</p>
<p>本記事では、WebAssemblyをターゲットとするコンパイラ処理系を実装します。</p>
<h1>方針</h1>
<p>WebAssemblyへのコンパイル言語処理系を<strong><em>最も簡単に</em></strong> <sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>実装するための方針は以下のとおり。</p>
<ul>
<li>言語は「<a href="https://ja.wikipedia.org/wiki/Brainfuck">コンパイラがなるべく小さくなる言語として考案</a>」されたBrainf*ckを採用</li>
<li>文法は<a href="https://ja.wikipedia.org/wiki/Parsing_Expression_Grammar">PEG(Parsing Expression Grammar)</a>で記述し、生成系<a href="https://pegjs.org/">PEG.js</a>でパーサを実行時に生成する</li>
<li>WebAssemblyコード生成では文字列でWAST形式を生成し、<a href="https://github.com/ewasm/wast2wasm">wast2wasm</a><sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup>で変換する(直接WASMを生成しない)。またEmscriptenやbinaryenは使用しない</li>
<li>WASTの表現ではflat形式ではなくs-expression形式を使用する</li>
<li>ブラウザ上ではなくNode上で実行する。なのでWebAssemblyを実行できるバージョンのNode.jsが必要。Node8以降では普通に実行できる</li>
</ul>
<p>コードは<a href="https://github.com/uehaj/bf-compiler-webassembly">こちら</a>に。
NPMに登録されているので以下で実行できます。</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">% <span class="token function">cat</span> hello.bf
+++++++++<span class="token punctuation">[</span><span class="token operator">></span>++++++++<span class="token operator">></span>+++++++++++<span class="token operator">></span>+++++<span class="token operator">&lt;&lt;&lt;</span>-<span class="token punctuation">]</span><span class="token operator">></span>.<span class="token operator">></span>++.+++++++<span class="token punctuation">..</span>+++.<span class="token operator">></span>-.------------.<span class="token operator">&lt;</span>++++++++.--------.+++.------.--------.<span class="token operator">></span>+.

% npx bf-compiler-webassembly hello.bf
npx: <span class="token number">5</span>個のパッケージを1.592秒でインストールしました。
Hello, world<span class="token operator">!</span>

% npx bf-compiler-webassembly -e <span class="token string">'+++++++++[>++++++++>+++++++++++>+++++&lt;&lt;&lt;-]>.>++.+++++++..+++.>-.------------.&lt;++++++++.--------.+++.------.--------.>+.'</span>
npx: <span class="token number">5</span>個のパッケージを2.06秒でインストールしました。
Hello, world<span class="token operator">!</span>

% npx bf-compiler-webassembly --help
npx: <span class="token number">5</span>個のパッケージを1.506秒でインストールしました。

  Usage: bf-compiler-webassembly <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>file<span class="token punctuation">..</span>.<span class="token punctuation">]</span>


  Options:

    -V, --version         output the version number
    -e,--script <span class="token punctuation">[</span>script<span class="token punctuation">]</span>  run script from <span class="token builtin class-name">command</span> line
    -v,--verbose          verbose output
    -h, --help            output usage information


  Examples:

    $ npx bf-compiler-webassembly -e <span class="token string">"+++"</span>
    $ npx bf-compiler-webassembly hello.bf</code></pre></div>
<h1>実行例</h1>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/9979/d79db6b1-f1ba-f816-b6ea-7f5481a650b3.gif" alt="bf2.mov.gif"></p>
<p>以降、コードの説明をしていきます。</p>
<h1>全体の流れ</h1>
<div class="gatsby-highlight" data-language="js:driver.js"><pre class="language-js:driver.js"><code class="language-js:driver.js">// compile from string
async function compileAndRunString(bfSource, opts) {
  const bfAst = bfParser.parse(bfSource, opts);
  const wast = bfCompiler.compile(bfAst, opts);
  const wasm = await wast2wasm.convert(wast, opts);
  return await wasmRuner.run(wasm, opts);
}</code></pre></div>
<p><a href="https://github.com/uehaj/bf-compiler-webassembly/blob/master/lib/driver.js">driver.js</a>でコンパイル・実行の全体の流れを制御しています。以下の順で処理が実行されます。</p>
<ol>
<li>Brainf*ckコードの構文解析(パース)、ASTの生成。(<a href="https://github.com/uehaj/bf-compiler-webassembly/blob/master/lib/bfParser.js">bfParser.parse()</a>)</li>
<li>ASTをwastに変換する(コード生成)。(<a href="https://github.com/uehaj/bf-compiler-webassembly/blob/master/lib/bfCompiler.js">bfCompiler.compile()</a>)</li>
<li>wast形式をwasmに変換し、WASMのバイト列表現に変換。(<a href="https://github.com/uehaj/bf-compiler-webassembly/blob/master/lib/wast2wasm.js">wast2wasm.convert()</a>)</li>
<li>WASMバイト列をWebAssemblyの内部形式(機械語?)に変換・コンパイルし、wasmコードを呼び出して実行する。(<a href="https://github.com/uehaj/bf-compiler-webassembly/blob/master/lib/wasmRunner.js">wasmRunner.run()</a>)</li>
</ol>
<p>それぞれ以下のように処理ごとにモジュール化しています。</p>
<div class="gatsby-highlight" data-language="js:driver.js"><pre class="language-js:driver.js"><code class="language-js:driver.js">const bfParser = require(&#39;./bfParser&#39;);
const bfCompiler = require(&#39;./bfCompiler&#39;);
const wast2wasm = require(&#39;./wast2wasm&#39;);
const wasmRuner = require(&#39;./wasmRunner&#39;);</code></pre></div>
<h1>パーサ</h1>
<p>rainf*ckを構文解析してASTを生成するパーサをPEG.jsで作成します。</p>
<div class="gatsby-highlight" data-language="js:bfparser.js"><pre class="language-js:bfparser.js"><code class="language-js:bfparser.js">const peg = require(&#39;pegjs&#39;);

const syntax = `
code = (normal_insn / block_insn / otherchar) *

normal_insn = ch:[&gt;&lt;+-.,] { return ch }
block_insn = &#39;[&#39; brk:block &#39;]&#39; { return brk  }

block = cod:code {
  return cod;
}

otherchar = [^&gt;&lt;+-.,\\[\\]] {
  return undefined
}
`;

const parser = peg.generate(syntax);</code></pre></div>
<p>syntaxという文字列変数にPEG文法を与えてpeg.generate()でパーサを生成しています。
PEGでBNFのように構文を表現します。PEGでは構文解析と字句解析を分ける必要がありません。</p>
<div class="gatsby-highlight" data-language="js:bfparser.js"><pre class="language-js:bfparser.js"><code class="language-js:bfparser.js">function parse(bfSource, opts) {
  const bfAst = parser.parse(bfSource);
  return bfAst;
}</code></pre></div>
<p>生成したパーサにBrainf*ckのコードを与えて抽象構文木を返します。
PEGのJS実装であるPEG.jsが生成するパーサは、JSONで抽象構文木を返してくれます。
抽象構文木(という程のものでもありませんが)では、[と]で表現されるブロックは配列、それ以外はその文字の配列が返ります。</p>
<div class="gatsby-highlight" data-language="brainfuck"><pre class="language-brainfuck"><code class="language-brainfuck"><span class="token operator">,</span><span class="token branching important">[</span><span class="token decrement deleted">-</span><span class="token pointer keyword">></span><span class="token increment inserted">+</span><span class="token pointer keyword">&lt;</span><span class="token branching important">]</span><span class="token pointer keyword">></span><span class="token increment inserted">+</span><span class="token operator">.</span></code></pre></div>
<p>であれば、以下のようなJSONが返ります。</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span> '<span class="token punctuation">,</span>'<span class="token punctuation">,</span> <span class="token punctuation">[</span> '-'<span class="token punctuation">,</span> '>'<span class="token punctuation">,</span> '+'<span class="token punctuation">,</span> '&lt;' <span class="token punctuation">]</span><span class="token punctuation">,</span> '>'<span class="token punctuation">,</span> '+'<span class="token punctuation">,</span> '.' <span class="token punctuation">]</span></code></pre></div>
<p>[と]の対応は静的にコンパイル時チェックされることになります。</p>
<h1>コード生成</h1>
<p>抽象構文木を再帰的に辿って<a href="https://ukyo.github.io/wasm-usui-book/webroot/text-format.html">WAST形式テキスト</a>を生成します。
先のBFコードは以下を生成します。</p>
<div class="gatsby-highlight" data-language="lisp"><pre class="language-lisp"><code class="language-lisp"><span class="token punctuation">(</span><span class="token car">module</span>
  <span class="token punctuation">(</span><span class="token car">func</span> $getchar <span class="token punctuation">(</span><span class="token car">import</span> <span class="token string">"imports"</span> <span class="token string">"getchar"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">result</span> i32<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">func</span> $putchar <span class="token punctuation">(</span><span class="token car">import</span> <span class="token string">"imports"</span> <span class="token string">"putchar"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">param</span> i32<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">memory</span> $0 <span class="token punctuation">(</span><span class="token car">export</span> <span class="token string">"memory"</span><span class="token punctuation">)</span> <span class="token number">1</span> <span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token punctuation">(</span><span class="token car">func</span> <span class="token punctuation">(</span><span class="token car">export</span> <span class="token string">"main"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">local</span> $ptr i32<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token car">i32</span>.store8 <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">call</span> $getchar<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; ,</span>
    <span class="token punctuation">(</span><span class="token car">block</span> <span class="token comment">;; [</span>
      <span class="token punctuation">(</span><span class="token car">loop</span>
        <span class="token punctuation">(</span><span class="token car">br_if</span> <span class="token number">1</span> <span class="token punctuation">(</span><span class="token car">i32</span>.eqz <span class="token punctuation">(</span><span class="token car">i32</span>.load8_s <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token car">i32</span>.store8 <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">i32</span>.sub <span class="token punctuation">(</span><span class="token car">i32</span>.load8_s <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">i32</span>.const <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; -</span>
        <span class="token punctuation">(</span><span class="token car">set_local</span> $ptr <span class="token punctuation">(</span><span class="token car">i32</span>.add <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">i32</span>.const <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; ></span>
        <span class="token punctuation">(</span><span class="token car">i32</span>.store8 <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">i32</span>.add <span class="token punctuation">(</span><span class="token car">i32</span>.load8_s <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">i32</span>.const <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; +</span>
        <span class="token punctuation">(</span><span class="token car">set_local</span> $ptr <span class="token punctuation">(</span><span class="token car">i32</span>.sub <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">i32</span>.const <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; &lt;</span>
        <span class="token punctuation">(</span><span class="token car">br</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token comment">;; ]</span>
    <span class="token punctuation">(</span><span class="token car">set_local</span> $ptr <span class="token punctuation">(</span><span class="token car">i32</span>.add <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">i32</span>.const <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; ></span>
    <span class="token punctuation">(</span><span class="token car">i32</span>.store8 <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">i32</span>.add <span class="token punctuation">(</span><span class="token car">i32</span>.load8_s <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">i32</span>.const <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; +</span>
    <span class="token punctuation">(</span><span class="token car">i32</span>.load8_s <span class="token punctuation">(</span><span class="token car">get_local</span> $ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">call</span> $putchar<span class="token punctuation">)</span> <span class="token comment">;; .</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre></div>
<h1>生成コードの説明</h1>
<h2>冒頭のいくつかの宣言</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">  (func $getchar (import &quot;imports&quot; &quot;getchar&quot;) (result i32))
  (func $putchar (import &quot;imports&quot; &quot;putchar&quot;) (param i32))</code></pre></div>
<p>BFでの入出力を行うためのgetchar、putcharを外部JS関数として供給します。</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">  (memory $0 (export &quot;memory&quot;) 1 1)</code></pre></div>
<p>memoryでWebAssemby側でメモリ領域を<a href="https://github.com/sunfishcode/wasm-reference-manual/blob/master/WebAssembly.md#linear-memories">リニアメモリ</a>として確保。サイズと最大サイズをブロックサイズで指定。ここではいずれも1ブロック(64 KiB)を指定。</p>
<h2>コード本体の定義</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">  (func (export &quot;main&quot;) (local $ptr i32)</code></pre></div>
<p>JSから呼べる関数としてWebAssembly関数をmainという名前でexport。</p>
<p>以降、関数本体となる実行命令の説明をしていきます。</p>
<h2>'['と']'に対応するコード</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">    (block ;; [
      (loop
        (br_if 1 (i32.eqz (i32.load8_s (get_local $ptr))))
:
        (br 0)
      )
    ) ;; ]</code></pre></div>
<p>whileループに相当する[〜]のブロックがコンパイルされたコード。ptrの内容がゼロならループを抜け<code class="language-text">(br_if 1)</code>、loop末尾でloopの先頭にジャンプ<code class="language-text">(br 0)</code>しています。brはbranchの略で、分岐もしくは条件付き分岐命令です。
wast2wasmではなぜかbrの飛び先をラベルで指定できなかったので、ネストレベルの相対指定<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>で飛び先を指定しています。「0」は最内周のloopもしくはblock、「1」は1段外側のレベルのloopもしくはblockを意味します。ラベルを管理する必要がないので、ここでは好都合です。</p>
<p>brやbr_ifのジャンプの動作は、指定したネストレベルに対応するものがloopであればloop冒頭にジャンプ(ここではwhileループ内でのcontinue文の動作)、blockであればblockの末尾にジャンプ(ここではwhileループのbreak)をします。</p>
<h2>'+'と'-'に対応するコード</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(i32.store8 (get_local $ptr) (i32.add (i32.load8_s (get_local $ptr)) (i32.const 1))) ;; +
(i32.store8 (get_local $ptr) (i32.sub (i32.load8_s (get_local $ptr)) (i32.const 1))) ;; -</code></pre></div>
<p>$ptrで間接参照したリニアメモリの指す先の内容を1バイトloadして加減算してリニアメモリにstoreし戻します。i32.load8は拡幅になるので符号付きと無しがあり、この場合は符号付きで処理するように注意します。</p>
<h2>'>'と'&#x3C;'に対応するコード</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(set_local $ptr (i32.add (get_local $ptr) (i32.const 1))) ;; &gt;
(set_local $ptr (i32.sub (get_local $ptr) (i32.const 1))) ;; &lt;</code></pre></div>
<p>$ptrを増減させます。</p>
<h2>'.'と','に対応するコード</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(i32.load8_s (get_local $ptr)) (call $putchar) ;; .
(i32.store8 (get_local $ptr) (call $getchar)) ;; ,</code></pre></div>
<p>importsで宣言されているJS関数を指定して呼び出します。ここで用意したのはいずれも同期的な関数です。非同期関数を呼ぶ際にはコールバック関数を指定する必要がありますが、ここでは簡単さを優先するために同期関数で以下のように実装しておいたものを呼び出しています。</p>
<div class="gatsby-highlight" data-language="js:wasmrunner.js"><pre class="language-js:wasmrunner.js"><code class="language-js:wasmrunner.js">const readlineSync = require(&#39;readline-sync&#39;);
 :
function putchar(ch) {
  process.stdout.write(String.fromCharCode(ch));
}

let buf = &#39;&#39;;
function getchar() {
  if (buf === &#39;&#39;) {
    buf = buf + readlineSync.question() + &#39;\n&#39;;
  }
  const result = buf.charCodeAt(0);
  buf = buf.substring(1);
  return result;
}</code></pre></div>
<h1>WAST→WASM変換</h1>
<div class="gatsby-highlight" data-language="wast2wasm.js"><pre class="language-wast2wasm.js"><code class="language-wast2wasm.js">const wast2wasm = require(&#39;wast2wasm&#39;);

async function convert(wasmTextCode, opts) {
  const wasm = await wast2wasm(wasmTextCode, true);
  if (opts.verbose || process.env.NODE_ENV === &#39;debug&#39;) {
    console.log(wasm.log);
  }
  return wasm.buffer;
}</code></pre></div>
<p>wastをwasmのバイト列表現に変換します。</p>
<h1>実行</h1>
<div class="gatsby-highlight" data-language="js:wastrunner.js"><pre class="language-js:wastrunner.js"><code class="language-js:wastrunner.js">async function run(uint8array, opts) {
  const wasm = await WebAssembly.instantiate(uint8array, {
    imports: {
      getchar,
      putchar,
    },
  });

  const result = wasm.instance.exports.main();
  if (opts.verbose || process.env.NODE_ENV === &#39;debug&#39;) {
    const memory = new Uint8Array(wasm.instance.exports.memory.buffer);
    console.log(memory);
  }
  return result;
}</code></pre></div>
<p>受け取ったwasmのバイト列表現をWebAssembly.instantiate()で実際のコンパイルを行い、WebAssemblyインスタンスを生成します。通常のWebAssembly実行であれば、wasm生成までは事前コンパイルでできていて、wasmのロードから始まるところ。
そして、exportされた関数(ここではmainで固定)を実行します。</p>
<h1>コマンドラインの処理</h1>
<p><a href="https://www.npmjs.com/package/commander">commander</a>を使用して簡潔に。</p>
<div class="gatsby-highlight" data-language="js:index.js"><pre class="language-js:index.js"><code class="language-js:index.js">const program = require(&#39;commander&#39;);
const driver = require(&#39;../lib/driver&#39;);

function main(argv) {
  program
    .version(&#39;0.1.0&#39;)
    .option(&#39;-e,--script [script]&#39;, &#39;run script from command line&#39;)
    .option(&#39;-v,--verbose&#39;, &#39;verbose output&#39;)
    .arguments(&#39;[file...]&#39;, &#39;Brainf*ck file&#39;)
    .action(function(files, opts) {
      for (const file of files) {
        driver
          .compileAndRunFile(file, { verbose: opts.verbose })
          .catch(e =&gt; console.log(&#39;error:&#39; + e));
      }
    })
    .on(&#39;--help&#39;, function() {
      console.log(`
      
  Examples:

    $ npx bf-compiler-webassembly -e &quot;+++&quot;
    $ npx bf-compiler-webassembly hello.bf

`);
    })
    .parse(argv);

  // for -e,--script option
  if (program.script) {
    driver
      .compileAndRunString(program.script, { verbose: program.verbose })
      .catch(e =&gt; console.log(&#39;error:&#39; + e));
  } else {
    program.args.length !== 0 || program.help();
  }
}

main(process.argv);</code></pre></div>
<h1>WASM所感</h1>
<p>スタックマシンで変数も使え命令の対称性も高くわかりやすい。JVMのようにクラスベースではなく関数ベースであることが様々な効果を発揮しすっきりしている。
呼び出しスタックを(引数やローカル変数を通じないで)直接見ることも書くこともできないのでスタック上をバッファオーバーフローで書き壊したり、リターンアドレス書き換えてコード呼び出される攻撃について安全。ヒープは別問題だが、間接参照呼び出しはtableという構造のインデックスのみで実現されるので列挙される関数の範囲に限定されるので比較的安全。引数や返り値の型や個数を指定する必要があり、軽くバイトコードベリファイがなされスタックズレなどは防止される。</p>
<h1>WAST形式所感</h1>
<p>WAST形式のS-expressionはLispっぽいですが、バイナリフォーマットとしてのWASMでの実際のバイト配置としてはFORTHのような逆ポーランド記法であり、これに対応するflat形式という記法もあるそうです(併用もできる?)。引数の評価順が決まっているのでS-Expressionとflat形式は1対1対応です。</p>
<h1>最適化</h1>
<p>していませんが、本来なら種々の最適化を実行することができるでしょう。たとえば複数連続する+や-、>や&#x3C;をまとめて計算するなどは効果的だろうし、BFの個々の命令をテーブルジャンプとか間接参照にすることも考えられます。</p>
<h1>まとめ</h1>
<ul>
<li>WebAssemblyはコンパイラの勉強のターゲットとしてモチベーションが高まるし、しきいも低いのでぜひどうぞ。</li>
<li>ただし現時点ではドキュメント不足、今後仕様が変化していくだろう、という予測もできます。</li>
<li>PEG.jsは便利。</li>
</ul>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">
<p>主観です。</p>
<a href="#fnref-1" class="footnote-backref">↩</a>
</li>
<li id="fn-3">
<p>wast2wabtはたぶん<a href="https://github.com/WebAssembly/wabt">WABT(The WebAssembly Binary Toolkit)</a>からEmscriptenか何かでJSに変換されている。</p>
<a href="#fnref-3" class="footnote-backref">↩</a>
</li>
<li id="fn-2">
<p>ネストレベルの外側向きの相対指定であることがドキュメント上読み取れず、ものすごく苦労した。</p>
<a href="#fnref-2" class="footnote-backref">↩</a>
</li>
</ol>
</div></div></article></div><footer class="site-footer"><p>© <!-- -->2020<!-- --> Delog • Crafted with <span role="img" aria-label="love">❤️</span> by <a href="https://w3layouts.com">W3Layouts</a></p></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/5276bd3425d1000e48ba";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-6fa501141d6fe72b85ff.js"],"app":["/app-d756fd09c6f43fe69c21.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-e5cb9e0c77a823b86dc2.js"],"component---src-pages-404-js":["/component---src-pages-404-js-a6650c0bdc38c41d8724.js"],"component---src-pages-contact-js":["/component---src-pages-contact-js-c2c0706dae8915fdae6f.js"],"component---src-pages-index-js":["/component---src-pages-index-js-5cda33e29d8b6a3d7958.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js-c07c43f15390ed3b46f3.js"]};/*]]>*/</script><script src="/uehaj-memo2/polyfill-6fa501141d6fe72b85ff.js" nomodule=""></script><script src="/uehaj-memo2/component---src-templates-blog-template-js-c07c43f15390ed3b46f3.js" async=""></script><script src="/uehaj-memo2/b34906bb45276341108473925e234e3fd24b49e8-b5d8b872c6394f34f95f.js" async=""></script><script src="/uehaj-memo2/styles-89fd2ae28bdf06750a71.js" async=""></script><script src="/uehaj-memo2/app-d756fd09c6f43fe69c21.js" async=""></script><script src="/uehaj-memo2/532a2f07-a09818a88319b8b503ee.js" async=""></script><script src="/uehaj-memo2/framework-a7bb16c5c6afeed647b2.js" async=""></script><script src="/uehaj-memo2/webpack-runtime-d61593428dc9acc550ef.js" async=""></script></body></html>