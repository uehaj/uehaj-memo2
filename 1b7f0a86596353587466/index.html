<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.57549d926a8ce7aa67e3.css">body,html{margin:0;padding:0}*{margin-top:0}body.light{--primary-color:#381696;--primary-text-color:#fff;--featured-bg:#493b8a;--secondary-color:#10072b;--background:#fff;--card-bg:#fff;--card-bdr:#eee;--card-shadow:#d5d5d5;--contact-bg:#f7f8fe;--contact-bdr:#d3d6e7;--input-bg:var(--background)}body.dark,body.light{--featured-text:#fff;--site-header:var(--background);--btn-bg:var(--background);--btn-bdr:#d3d6e7;--btn-text-color:#868892;--btn-hover-bg:var(--btn-bdr);--btn-hover-text-color:#00062b}body.dark{--primary-color:#9984d5;--primary-text-color:#fff;--featured-bg:#66578d;--secondary-color:#66578d;--background:#0a041a;--text-color:hsla(0,0%,100%,0.88);--text-secondary-color:hsla(0,0%,100%,0.66);--card-bg:#181326;--card-bdr:#181326;--card-shadow:#020204;--contact-bg:var(--card-shadow);--contact-bdr:var(--card-bg);--input-bg:var(--card-bg)}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif;border-top:10px solid var(--primary-color);background-color:var(--background);color:var(--text-color)}a{color:var(--primary-color);text-decoration:none}a:hover{text-decoration:underline}.site-wrapper{padding:32px;max-width:1140px;margin:0 auto}.site-wrapper img{max-width:100%}.navigation{display:flex;align-items:center;font-weight:300}.navigation a{color:#888;text-decoration:none;margin:0 8px}.navigation a[aria-current]{color:var(--primary-color);font-weight:700}.navigation a:hover{color:var(--primary-color)}.navigation a:last-child{margin-right:0}.site-header{display:flex;justify-content:space-between;padding:20px 0;background:var(--site-header);margin-bottom:32px;align-items:center}.site-title a{color:var(--primary-color);text-decoration:none;font-weight:900;text-transform:uppercase}.hero-header{padding:0 0 64px;max-width:980px}.headline{font-size:36px;font-weight:900;margin-bottom:.5rem}.button{padding:18px 27px;display:inline-block;background:var(--btn-bg);border:1px solid var(--btn-bdr);border-radius:9px;text-decoration:none;color:var(--btn-text-color);font-size:16px;font-weight:400;margin:0 20px 0 0;transition:background-color .3s linear}.button.-primary{background-color:var(--primary-color);border-color:var(--primary-color);color:var(--primary-text-color)}.button.-primary:hover{background-color:var(--secondary-color);color:var(--primary-text-color);text-decoration:none}.button:hover{background-color:var(--btn-hover-bg);color:var(--btn-hover-text-color)}.primary-content{font-size:18px;margin-bottom:32px;line-height:1.5;font-weight:300}.post{padding:0;background:var(--background);color:var(--text-color);line-height:1.5}.post>.blog-post-content{max-width:768px;margin:0 auto}.post>.blog-post-content :last-child,.post>:last-child{margin-bottom:0}.post .post-title{text-align:center;margin:0 0 .5rem;line-height:1.3;font-size:2rem}.post .post-meta{margin-bottom:32px;text-align:center}.post-thumbnail{text-align:center;min-height:380px;background-color:var(--featured-bg);background-repeat:no-repeat;background-size:cover;background-position:50%;border-radius:18px;margin-bottom:36px;color:var(--featured-text);display:grid;align-content:center;position:relative;padding:18px;overflow:hidden}.post-thumbnail:before{content:"";background:rgba(0,0,0,.4);position:absolute;top:0;left:0;width:100%;height:100%;z-index:1}.post-thumbnail>*{position:relative;z-index:2}.post-thumbnail .post-meta{color:hsla(0,0%,100%,.8);margin-bottom:0}.grids{display:grid;grid-template-columns:1fr;grid-gap:32px;margin-top:32px}.card{display:grid;background-color:var(--card-bg);border-radius:9px;border:1px solid var(--card-bdr);box-shadow:0 0 30px var(--card-shadow);overflow:hidden;line-height:1.5}.card:hover .post-link{color:var(--primary-color)}.card>a img{display:block}.card>header{padding:24px}.card>h2:first-child{margin:0 0 .5rem}.card .post-title{font-size:1.2rem;margin-bottom:.3rem}.card .post-meta{font-weight:100;margin-bottom:0}.card .post-link{color:var(--text-color);text-decoration:none}.post-meta{font-size:.8rem;color:var(--text-secondary-color)}.site-footer{text-align:center;margin:90px 0 16px;color:#666}.site-footer a{font-weight:700}.form-container{background-color:var(--contact-bg);padding:32px;border:1px solid var(--contact-bdr);border-radius:9px}.form-container label{display:block;margin-bottom:.5rem;color:var(--text-secondary-color)}.form-container input[type=email],.form-container input[type=text],.form-container textarea{-webkit-appearance:none;-moz-appearance:none;appearance:none;border:1px solid var(--card-shadow);color:var(--text-secondary-color);border-radius:6px;line-height:32px;padding:6px 12px;width:calc(100% - 24px);margin-bottom:1.5rem;background-color:var(--input-bg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}.form-container textarea{margin-bottom:2rem;height:150px}.two-grids{display:grid;grid-gap:32px}.two-grids.-contact .post-thumbnail{min-height:240px!important}@media only screen and (min-width:768px){.grids{grid-template-columns:1fr 1fr}}@media only screen and (min-width:1024px){.grids{grid-template-columns:1fr 1fr 1fr}.two-grids{display:grid;grid-template-columns:1fr 1fr;grid-gap:64px}}.theme-changer,body.dark .gg-moon,body.light .gg-sun{display:none}.mode-container{width:24px;height:24px;margin-left:20px}.gg-sun{position:relative;transform:scale(var(--ggs,1));height:24px;background:linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat 5px -6px/2px 6px,linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat 5px 14px/2px 6px,linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat -8px 5px/6px 2px,linear-gradient(180deg,currentColor 4px,transparent 0) no-repeat 14px 5px/6px 2px;border-radius:100px;box-shadow:inset 0 0 0 2px;border:6px solid transparent}.gg-sun,.gg-sun:after,.gg-sun:before{box-sizing:border-box;display:block;width:24px}.gg-sun:after,.gg-sun:before{content:"";position:absolute;height:2px;border-right:4px solid;border-left:4px solid;left:-6px;top:5px}.gg-sun:before{transform:rotate(-45deg)}.gg-sun:after{transform:rotate(45deg)}.gg-moon,.gg-moon:after{display:block;box-sizing:border-box;border-radius:50%}.gg-moon{overflow:hidden;position:relative;transform:rotate(-135deg) scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-bottom:2px solid transparent}.gg-moon:after{content:"";position:absolute;width:12px;height:18px;border:2px solid transparent;box-shadow:0 0 0 2px;top:8px;left:2px}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.24.2"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-164743872-1', 'auto', {});
      
      
      
      
      
      }</script><link rel="icon" href="/favicon-32x32.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#381696"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=fb3f3f1f0eb79016665dc2c3d852b9ca"/><title data-react-helmet="true">Reactベース静的サイトジェネレータGatsbyの真の力をお見せします | Delog</title><meta data-react-helmet="true" name="description"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-27e04d3fb6ed5fc97f7b.js"/><link as="script" rel="preload" href="/framework-a7bb16c5c6afeed647b2.js"/><link as="script" rel="preload" href="/532a2f07-a09818a88319b8b503ee.js"/><link as="script" rel="preload" href="/app-519a9dea873641f71b75.js"/><link as="script" rel="preload" href="/styles-89fd2ae28bdf06750a71.js"/><link as="script" rel="preload" href="/b34906bb45276341108473925e234e3fd24b49e8-b5d8b872c6394f34f95f.js"/><link as="script" rel="preload" href="/component---src-templates-blog-template-js-c07c43f15390ed3b46f3.js"/><link as="fetch" rel="preload" href="/page-data/1b7f0a86596353587466/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="site-wrapper"><header class="site-header"><div class="site-title"><a href="/">Delog</a></div><nav class="navigation"><a href="/contact">Contact</a><label><input type="checkbox" class="theme-changer"/> <div class="mode-container"><i class="gg-sun"></i><i class="gg-moon"></i></div></label></nav></header><div class="blog-post-container"><article class="post"><div class="post-thumbnail"><h1 class="post-title">Reactベース静的サイトジェネレータGatsbyの真の力をお見せします</h1><div class="post-meta">January 01, 1970</div></div><div class="blog-post-content"><p>NTTテクノクロスの上原です。
業務では、社内情報のReact製自前キュレーションサイトの構築を担当しています。
この記事は<a href="https://qiita.com/advent-calendar/2018/ntt-tx">NTTテクノクロスAdvent Calendar24日目</a>の記事であり、社内の勉強会で発表した内容をQiita記事として書きなおしたものです。タイトルは釣りです。
(<a href="/1b7f0a86596353587466#20181228%E8%BF%BD%E8%A8%98">2018/12/28追記</a>あり)</p>
<h1>導入</h1>
<h2>記事を書いた理由</h2>
<p><a href="https://www.gatsbyjs.org/">Gatsby.js</a>(以降、Gatsbyと表記)は<a href="https://www.gatsbyjs.org/docs/performance/">さまざまな高速化テクニック</a>を用いた「爆速サイト生成」で有名なツールですが、そのリッチな機能性は、たとえばイントラ内サイト、業務システム開発、ツール開発などでも十分に活用できるものだと思い、その可能性を紹介するために書きました。</p>
<h2>「静的サイトジェネレータ」って何？</h2>
<p>いわゆる「静的サイトジェネレータ(Static Site Generator, SSG)」は、CMS(コンテンツ管理システム)の一種です。代表的なものには以下があります。</p>
<ul>
<li><a href="https://jekyllrb-ja.github.io/">Jekyll</a></li>
<li><a href="https://gohugo.io/">Hugo</a></li>
<li><a href="http://octopress.org/">Octopress</a> <br/>
　 :</li>
</ul>
<p>他にも<a href="https://www.staticgen.com/">多くが実装・公開</a>されています。</p>
<p>Webサイトの公開・構築に良く使われるWordPressなどのCMSは、記事の「閲覧時」に動的にサイト内容を生成しますが、静的サイトジェネレータは、閲覧時ではなく「ビルド時」にHTMLやCSSなどをあらかじめ生成しておくことが特徴です。</p>
<h2>一般的な利点</h2>
<p>「静的サイトジェネレータ」の一般的な利点は以下のとおりです。</p>
<ul>
<li>
<p>Webサイトのコンテンツを、サーバの設定や実行なしでAWS S3やGitHub pagesに置ける。これにより</p>
<ul>
<li>アプリサーバやDBが落ちるといった事象によってサイト公開が停止することがない</li>
<li>処理負荷に強い</li>
<li>動的CMS(Wordpress等)やアプリサーバ処理、DB処理に起因する脆弱性は回避できる</li>
<li>背景: Wordpress(及びそのプラグイン)の脆弱性は頻繁に発見されるので対応が大変</li>
<li>サーバの利用・運用コストを削減できる</li>
</ul>
</li>
<li>CDNと相性が良くスケールしやすい</li>
<li>Gitでコンテンツ管理ができる</li>
</ul>
<h2>Gatsbyとは</h2>
<p>Gatsbyは、松田優作のCMでおなじみの...ではなく、ここではReactベースの静的サイトジェネレータです。最新のフロントエンド技術を駆使し、高速に閲覧できるサイトを生成できることで有名です。</p>
<p>たとえば、Reactの<a href="https://reactjs.org/">公式サイト</a>はGatsbyを使用したサイトですが、このサイトをDevToolsで観察しながら閲覧すると、ページをスクロールするのに応じてクリックしなくても通信が走ることがわかります。これは、Gatsbyのランタイムが、表示エリアにリンクがはいってきた時点でリンク先コンテンツをプリフェッチしメモリ中に読み込み、クリック時には瞬時に表示できるようにしているからです。このような<a href="https://www.gatsbyjs.org/docs/performance/">高速化のための高度な工夫</a>が各種行われています。</p>
<h2>わたしの疑問</h2>
<p>自分が当初Gatsbyについて理解できていなかったのは、Reactとの関係です。</p>
<p>静的サイトジェネレータというぐらいだから、GatsbyはReactコードをSSR(Server Side Rendering)のようにあらかじめレンダリングして、静的なHTMLを事前に生成するのかな、と思いました。だから、JSコードはビルド時のみに実行されて、閲覧時には実行されないのかな、と。</p>
<p>このように思った理由は、他の静的サイトジェネレータの動作からの類推で、たとえばRubyベースのJekyllなどは、ビルド時にテンプレートをRubyインタプリタで評価してHTMLを生成し、閲覧時には一切Rubyコードは実行されません(されたら静的にならない)。ならば同じく、Gatsbyでも「JSコードはビルド時のみに実行されて、閲覧時には実行されない」のかなと思うじゃないですか。</p>
<p>しかし、調べると、そうではありませんでした。</p>
<h1>Gatsbyの特徴と動作</h1>
<p><strong><em>GatsbyはSSR的な静的HTML生成に加えて、それと連動する通常のReactアプリも生成します。</em></strong>
Create React AppやNext.jsと同様に、Reactで開発する<strong><em>SPAの自由度を完全に具備する</em></strong>ものです。</p>
<p>詳しく見てみましょう。</p>
<h2>Create React App(CRA)の動作</h2>
<p>まず、Gatsbyの説明をする前に、Create React Appを使ったときのReactアプリの生成と動作の様子を見てみます。下図のように、ビルド時に<code class="language-text">create-react-app build</code> コマンドを実行、bundle.jsを生成し、それを読み込むindex.htmlと合わせてデプロイします。Reactアプリは、ブラウザ中で初めて実行されます。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/9979/7b9dbeed-d816-e382-74fa-79be90d036a3.png" alt="output_751673bcbfe8ef280417264a4042c06d-0.png"></p>
<h2>一般的なSSR(Next.jsなど)の動作</h2>
<p>次に、Next.jsなどを用いたSSR(Server Side Rendering)を見てみましょう。
ブラウザが初期ページを読み込むタイミングで、サーバ側のNode.jsでReactアプリが実行され、初期HTMLを生成(SSR)します。ブラウザがそれを読み込んで初期表示し、引き続きReactアプリを実行し、仮想DOMの更新や、SPAとしての実行にうまいこと繋げてくれます。必要があればReduxのステートの転送なども行なわれます。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/9979/d845a654-5e27-b74f-683c-02d220d7129a.png" alt="output_751673bcbfe8ef280417264a4042c06d-1.png"></p>
<h2>Gatsbyの動作</h2>
<p>さて、Gatsbyです。Gatsbyは、Reactアプリをビルド時に1回実行し、HTMLを生成します。HTMLを生成する動作はSSRと同様なのですが、サーバ上ではなく、ビルドマシン上で実行することが異なります。このHTMLをJSと共にデプロイし、ブラウザはそれを初期ページとして読み込み、SSRと同様にReactアプリの実行が再度なされ、仮想DOM更新、SPAとしての実行、Reduxステートなどが引き継がれます。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/9979/2da83462-0ab5-5827-4cb3-99239359b088.png" alt="output_751673bcbfe8ef280417264a4042c06d-2.png"></p>
<p>そして、ブラウザ内でのReactアプリとしての実行は通常と同じで、API呼び出しを実行しても良いし、redux-sagaの実行など、任意の動作が可能です<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup>。ただし、プリフェッチやコード分割にも関わるので、ルーティングはGatsbyの仕組みに従った方が良いでしょう<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>。Gatsbyでは、ルーティングは内部的にアクセシビリティ(a11y)向上のために<a href="https://www.gatsbyjs.org/blog/2018-09-27-reach-router/">@reach/routerが使用</a>されています。</p>
<p><a href="https://material-ui.com/">Material UI</a>なども<a href="https://www.gatsbyjs.org/packages/gatsby-plugin-material-ui/">プラグインを使用して</a>使用可能です(<a href="https://github.com/gatsbyjs/gatsby/issues/9200#issuecomment-434604930">コード例</a>、<a href="https://qiita.com/github0013@github/items/f268ca6609e47298d308">参考になるページ</a>)</p>
<h1>Gatsby動作をもう少し詳しく</h1>
<h2>ビルド時GraphQL</h2>
<p>上記まででも、サイト作成には十分に便利だと思いますが、Gatsbyのもう一つの大きな特徴は、ビルド時のさまざまな処理(データ取得と変換、使用)を「<a href="https://www.gatsbyjs.org/docs/graphql/">ビルド時GraphQL</a>」で統一的に行えることです。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/9979/afdcbeda-545b-f556-b8cf-57b4c2169ba9.png" alt="output_751673bcbfe8ef280417264a4042c06d-3.png"></p>
<p>静的サイトジェネレータとしての典型的な処理は、Markdown形式のテキスト情報を、ファイルシステムから読み込んで、GraphQL経由で取得し、Reactコンポーネント内で表示することです。
しかし、Gatsbyではそれを上記のようにdata source, data transformerという枠組みで一般化することで、多様な処理を統一的にかつ簡潔に記述することができます。</p>
<h2>こんなこともできる</h2>
<p>ビルド時に形成されるGraphQL DBの内容は、ブラウザ内での実行時にはアクセスできません。これはビルド時だけのものです。
ちなみにたとえば、実行時にまったく別のGraphQLサーバにアクセスすることができます。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/9979/ddb761b3-7192-4985-a9f5-36aae334829c.png" alt="output_751673bcbfe8ef280417264a4042c06d-4.png"></p>
<h2>「ビルド時GraphQL」の結果をブラウザ内のReactコンポーネントにも渡す</h2>
<p>さてここで一つの疑問が浮かぶかもしれません。
ビルド時に形成されるGraphQL DBの内容は、閲覧時のブラウザ内のReactアプリからはアクセスできないとしたら、ビルド時に得られたGraphQLのクエリ結果の情報は、ブラウザ内のReactコンポーネントではどのように入手できるのでしょうか? それが取得できないかぎり、SPAとしてHTMLと同じ画面を再現することはできません。
生成物を見ると、Gatsbyはこの問題を解決するために以下のような処理をしているようです。</p>
<ol>
<li>ビルド時</li>
<li>GraphQLクエリをビルド時実行</li>
<li>クエリ結果を使ってReactアプリを静的HTMLにレンダリング</li>
<li>このとき得られたGraphQLのクエリ結果はJSONで保存しておく。</li>
<li>デプロイ時</li>
<li>上記で生成された静的HTMLをデプロイ</li>
<li>同時に、上で保存していたJSONも静的コンテンツとしてデプロイ</li>
<li>ブラウザでの閲覧時</li>
<li>静的HTMLを初期表示</li>
<li>裏でReactアプリ実行、仮想DOMを再構築(SSRと同じ)</li>
<li>保存されたJSONを読み込み、同じ表示を再現する</li>
</ol>
<p>まとめると、ビルド時に形成されたGarphQL DBの全体は必要ないので、「クエリの結果」のみをJSONとして合わせてデプロイし、ブラウザ内ではGraphQL DBクエリ結果取得の代りにJSON値を使うことで、同じ表示を再現するというわけです。</p>
<h2>Gatsby Plugins</h2>
<p>GraphQL DBを作成するために、種々の<a href="https://www.gatsbyjs.org/plugins/?=tranformer">data transformer</a>,<a href="https://www.gatsbyjs.org/plugins/?=source">data source</a>がプラグインとして利用可能です。</p>
<a href="https://www.gatsbyjs.org/plugins/">
![output_751673bcbfe8ef280417264a4042c06d-5.png](https://qiita-image-store.s3.amazonaws.com/0/9979/812431ca-6ab0-f08c-6fa4-a81ec237ae36.png)
</a>
<h2>コード例</h2>
<p>以下に、GraphQLを使ったGatsbyコードの例を示します。
処理内容は、<a href="https://www.gatsbyjs.org/packages/gatsby-source-wordpress/">gatsby-source-wordpress</a>を用いてWordPressからAPIでビルド時に記事をとって来て、アイキャッチ画像含めたリンクとして画面に嵌め込むというものです。</p>
<p>Wordpress APIでビルド時に取得された情報から、以下のGraphQL クエリで一連の記事情報を取り出します。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">withRoot</span><span class="token punctuation">(</span><span class="token function">withStyles</span><span class="token punctuation">(</span>styles<span class="token punctuation">)</span><span class="token punctuation">(</span>Top<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> pageQuery <span class="token operator">=</span> graphql<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  query {
    allWordpressPost {
      edges {
        node {
          id
          title
          link
          content
          featured_media {
            source_url
          }
        }
      }
    }
  }
</span><span class="token template-punctuation string">`</span></span></code></pre></div>
<p>以下ではクエリ結果としての記事情報を、Reactコンポーネントの内容に組み込んでいます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">BlogPosts</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span>IProps<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> classes<span class="token punctuation">,</span> allWordpressPost <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div
        className<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span>classes<span class="token punctuation">.</span>layout<span class="token punctuation">)</span><span class="token punctuation">}</span>
        style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginTop<span class="token operator">:</span> <span class="token string">'1rem'</span><span class="token punctuation">,</span> marginBottom<span class="token operator">:</span> <span class="token string">'1rem'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token operator">&lt;</span>Grid container<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">}</span> spacing<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">40</span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>allWordpressPost<span class="token punctuation">.</span>edges<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">edge</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> content <span class="token operator">=</span> edge<span class="token punctuation">.</span>node<span class="token punctuation">.</span>content <span class="token operator">?</span> edge<span class="token punctuation">.</span>node<span class="token punctuation">.</span>content <span class="token operator">:</span> <span class="token string">''</span>
            <span class="token keyword">const</span> strippedContent <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;(?:.|\n)*?>/gm</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> <span class="token punctuation">(</span>
              <span class="token operator">&lt;</span>Grid key<span class="token operator">=</span><span class="token punctuation">{</span>edge<span class="token punctuation">.</span>node<span class="token punctuation">.</span>id<span class="token punctuation">}</span> item<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">}</span> xs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">12</span><span class="token punctuation">}</span> sm<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span> md<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span> lg<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token operator">></span>
                <span class="token operator">&lt;</span>ContentCard
                  imageUrl<span class="token operator">=</span><span class="token punctuation">{</span>edge<span class="token punctuation">.</span>node<span class="token punctuation">.</span>featured_media<span class="token punctuation">.</span>source_url<span class="token punctuation">}</span>
                  heading<span class="token operator">=</span><span class="token punctuation">{</span>edge<span class="token punctuation">.</span>node<span class="token punctuation">.</span>title<span class="token punctuation">}</span>
                  targetUrl<span class="token operator">=</span><span class="token punctuation">{</span>edge<span class="token punctuation">.</span>node<span class="token punctuation">.</span>link<span class="token punctuation">}</span>
                <span class="token operator">></span>
                  <span class="token operator">&lt;</span>Typography component<span class="token operator">=</span><span class="token string">"p"</span><span class="token operator">></span><span class="token punctuation">{</span>strippedContent<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Typography<span class="token operator">></span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>ContentCard<span class="token operator">></span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>Grid<span class="token operator">></span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>Grid<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Gatsbyビルドのようす</h2>
<p>上記の準備の上、プラグインの設定もした上で、以下のようにGatsbyプロジェクトをビルドできます。ビルド中にWordpress APIにアクセスしていることがわかります。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">% <span class="token function">npm</span> run build
<span class="token operator">></span> gatsby-starter-default@1.0.0 build /Users/uehaj/work/201812/techhub-gatsby
<span class="token operator">></span> gatsby build

success <span class="token function">open</span> and validate gatsby-configs — <span class="token number">0.013</span> s
success load plugins — <span class="token number">0.270</span> s
success onPreInit — <span class="token number">4.173</span> s
success delete html and css files from previous builds — <span class="token number">0.063</span> s
success initialize cache — <span class="token number">0.006</span> s
success copy gatsby files — <span class="token number">0.710</span> s
success onPreBootstrap — <span class="token number">0.007</span> s
⠂ <span class="token builtin class-name">source</span> and transform nodes -<span class="token operator">></span> wordpress__POST fetched <span class="token builtin class-name">:</span> <span class="token number">12</span>
⢀ <span class="token builtin class-name">source</span> and transform nodes -<span class="token operator">></span> wordpress__PAGE fetched <span class="token builtin class-name">:</span> <span class="token number">5</span>
⠐ <span class="token builtin class-name">source</span> and transform nodes -<span class="token operator">></span> wordpress__wp_media fetched <span class="token builtin class-name">:</span> <span class="token number">38</span>
⠁ <span class="token builtin class-name">source</span> and transform nodes -<span class="token operator">></span> wordpress__wp_taxonomies fetched <span class="token builtin class-name">:</span> <span class="token number">1</span>
⠄ <span class="token builtin class-name">source</span> and transform nodes -<span class="token operator">></span> wordpress__CATEGORY fetched <span class="token builtin class-name">:</span> <span class="token number">4</span>
⢀ <span class="token builtin class-name">source</span> and transform nodes -<span class="token operator">></span> wordpress__TAG fetched <span class="token builtin class-name">:</span> <span class="token number">13</span>
⠈ <span class="token builtin class-name">source</span> and transform nodes -<span class="token operator">></span> wordpress__wp_users fetched <span class="token builtin class-name">:</span> <span class="token number">4</span>
success <span class="token builtin class-name">source</span> and transform nodes — <span class="token number">2.745</span> s
success building schema — <span class="token number">0.798</span>

  <span class="token builtin class-name">:</span></code></pre></div>
<h2>組込まれた表示例</h2>
<p><a href="http://demo.wp-api.org/">http://demo.wp-api.org/</a>サイトからWordPress API経由で記事を取得してReact画面に組み込んだ例は以下のとおり。アイキャッチ画像が設定されてないので寂しい…。</p>
<img width="996" alt="スクリーンショット 2018-12-30 20.40.43.png" src="https://qiita-image-store.s3.amazonaws.com/0/9979/320da9c2-a7c8-7da8-832c-1e806ebce5f4.png">
# まとめ
<h2>「爆速サイト」が必要ない場合でも得られるGatsbyの利点</h2>
<p>サイトの高速性や、CDNで大規模スケールさせることは、イントラ向けシステムやツール開発などでは必ずしも必要ではないかもしれません。しかし、仮にそれを除いたとしても、Gatsbyには以下の利点があります。</p>
<ul>
<li>
<p><strong><em>通常ならDBで保持する/手書き修正のところ、ビルド時にUIに組込める</em></strong>。たとえば、</p>
<ul>
<li>入力フォームの「組織一覧」の選択肢を、ビルド時に他のWebサイトやAPI、CSVなどから取得し・最新化する</li>
<li>インクリメンタルサーチの選択肢</li>
<li>「運営からのお知らせ」情報</li>
<li>なんらかの巡回収集</li>
<li>運用環境からはセキュリティ上の理由でアクセス可能にさせたくない情報源から抽出した情報の組み込み</li>
</ul>
</li>
<li>上記をGraphQLとプラグイン群を使って、<strong><em>極めてシンプルに書ける</em></strong>。</li>
<li>
<p>データの入力やオーサリングをWordPressなどCMSにまかせ、表示をカスタム化することでシステム開発を単純化できる</p>
<ul>
<li><strong><em>しかもPHPを書かずに !!</em></strong></li>
<li>この用途に特化した<a href="https://www.google.co.jp/search?q=headless+cms&#x26;rls=com.microsoft:ja:%7Breferrer:source?%7D&#x26;ie=UTF-8&#x26;oe=UTF-8&#x26;sourceid=ie7&#x26;rlz=1I7GFRE_ja">Headless CMSというジャンルのプロダクト</a>も出ている</li>
</ul>
</li>
<li>
<p>CD(Continuous Delivery,継続的デリバリ)と組合せると、<strong><em>有用性はさらにUP!</em></strong></p>
<ul>
<li>「記事をWordPressで公開したタイミングでwebhookを叩いてビルド、デプロイ」など</li>
</ul>
</li>
<li>各種の便利なプラグインが使用できる </li>
</ul>
<h2>JAMSatckアーキテクチャ1実装としてのGatsby</h2>
<p>ちなみに、Gatsbyのような静的サイト生成を活用したWebシステムアーキテクチャを「<a href="https://jamstack.org/">JAMSatckアーキテクチャ</a>」と呼ぶそうです。下図は<a href="https://jamstack.org/">https://jamstack.org/</a>より引用。</p>
<img width="1133" alt="スクリーンショット 2018-12-21 18.46.57.png" src="https://qiita-image-store.s3.amazonaws.com/0/9979/0f5ad0bf-5663-9209-91b4-089cedee1930.png">
<p>以下が噛み砕いたJAMStackべからず集です。</p>
<ul>
<li>Wordpressを使わない</li>
<li>ブラウジング時のSSRを使わない</li>
<li>モノリシックではない</li>
</ul>
<p>利点としては、静的サイトジェネレータで得られるものすべてに加え、CDN、およびその付随機能を活用できるということです。サーバーレス時代にも向いたアーキテクチャと言えるでしょう。</p>
<h2>おわりに</h2>
<p>まとめますと、</p>
<ul>
<li>
<p>Gatsbyを「静的サイトジェネレータ」と呼んでしまうと、「動的サイト」は作れない、という印象をもってしまうかもしれないがそうではなく<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>、React SPAとしてのすべての機能を発揮できる、CRAと同種の存在でもある。</p>
<ul>
<li>CRAと同様に、babelやwebpackを呼び出す</li>
</ul>
</li>
<li>もちろん、Wordpress代替として爆速、CDNを駆使しスケールする、といった優れた性質をもっており、Gatsbyにとって「静的サイトをジェネレートすること」は主要な用途である。</li>
<li>
<p>しかしながら、Gatsbyの有効性はそれに限られず、以下のような利点があり、着目したい。</p>
<ul>
<li>UI構築の一部をビルド時に移動</li>
<li>ある種の「サーバレス」を推進</li>
<li>強力なGraphQLを駆使して、UIコード構築処理を(ビルド時に前倒しした上で)簡素化する。</li>
</ul>
</li>
</ul>
<p>と言うことで、いかがでしょうか、Gatsbyの魅力が少しでも伝われば幸いです。
では、みなさん良いお年を‼️(ムースをつけた両手で髪の毛をかきあげながら)</p>
<h1>2018/12/28追記</h1>
<p>記事を書いた後に、Gatsbyチームの方が<a href="https://www.reactiflux.com/transcripts/gatsby-team/">インタビューで以下のように発言</a>されているのを見つけました。本稿「私の疑問」のところで抱いた疑問は、他にも感じる人もいたということですね。</p>
<blockquote>
<p>Q: What is one thing that Gatsby is capable of doing that might surprise some people? — ctlee
A: Gatsby can be used to build fully dynamic sites, which surprises some people because of it’s label as a “static site generator”. It’s fully equipped to be a powerful alternative to create-react-app and other similar solutions with the addition of easy pre-rendering and perf baked in.</p>
</blockquote>
<p>(拙訳)</p>
<ul>
<li>Q: Gatsbyができることで、他の人が驚くかもしれないことは何ですか?</li>
<li>A: Gatsbyはフルに動的なサイトを開発するのに使うことができるが、Gatbyを「静的サイトジェネレータ」とラベリングしている人を驚かすときもあるかもね。これはcreate-react-app(や同種のもの)の完全でパワフルな機能代替であり、加えてプリレンダリングと高性能があらかじめ組込まれているものなんだ。</li>
</ul>
<div class="footnotes">
<hr>
<ol>
<li id="fn-2">
<p>Next.jsでもルーティングはNext.jsのルータにまかせるのと同様に。</p>
<a href="#fnref-2" class="footnote-backref">↩</a>
</li>
<li id="fn-3">
<p>とはいえ、今ビルド中なのか、ブラウザ中なのか、や、ライフサイクルフックを通じて緻密な分岐処理が必要になることもある。</p>
<a href="#fnref-3" class="footnote-backref">↩</a>
</li>
<li id="fn-1">
<p>SPAのサイトを「静的サイト」と呼べるなら静的サイトジェネレータでも良いわけだが、あまり聞かないような気がする。</p>
<a href="#fnref-1" class="footnote-backref">↩</a>
</li>
</ol>
</div></div></article></div><footer class="site-footer"><p>© <!-- -->2020<!-- --> Delog • Crafted with <span role="img" aria-label="love">❤️</span> by <a href="https://w3layouts.com">W3Layouts</a></p></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/1b7f0a86596353587466";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-6fa501141d6fe72b85ff.js"],"app":["/app-519a9dea873641f71b75.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-e5cb9e0c77a823b86dc2.js"],"component---src-pages-404-js":["/component---src-pages-404-js-a6650c0bdc38c41d8724.js"],"component---src-pages-contact-js":["/component---src-pages-contact-js-c2c0706dae8915fdae6f.js"],"component---src-pages-index-js":["/component---src-pages-index-js-5cda33e29d8b6a3d7958.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js-c07c43f15390ed3b46f3.js"]};/*]]>*/</script><script src="/polyfill-6fa501141d6fe72b85ff.js" nomodule=""></script><script src="/component---src-templates-blog-template-js-c07c43f15390ed3b46f3.js" async=""></script><script src="/b34906bb45276341108473925e234e3fd24b49e8-b5d8b872c6394f34f95f.js" async=""></script><script src="/styles-89fd2ae28bdf06750a71.js" async=""></script><script src="/app-519a9dea873641f71b75.js" async=""></script><script src="/532a2f07-a09818a88319b8b503ee.js" async=""></script><script src="/framework-a7bb16c5c6afeed647b2.js" async=""></script><script src="/webpack-runtime-27e04d3fb6ed5fc97f7b.js" async=""></script></body></html>